<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - FreshBites</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #fff6f0; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #ff6f61; }
        .order-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; padding: 20px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0d9d5; padding-bottom: 10px; margin-bottom: 15px; }
        .order-header h3 { margin: 0; }
        .order-status { font-weight: 600; padding: 5px 12px; border-radius: 20px; color: white; }
        .status-pending { background-color: #ffc107; }
        .status-accepted { background-color: #28a745; }
        .status-rejected { background-color: #dc3545; }
        .order-card ul { list-style: none; padding: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>My Orders</h1>
        <a href="index.html" style="margin-bottom: 20px; display: inline-block;">&larr; Back to Products</a>
        <div id="orders-container"><p>Loading your orders...</p></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA5_f3mtvEWeBNDzVyQtI22rXn3lpLeOjE",
            authDomain: "freshbites-platform.firebaseapp.com",
            projectId: "freshbites-platform",
            storageBucket: "freshbites-platform.appspot.com",
            messagingSenderId: "89904601475",
            appId: "1:89904601475:web:791328b498cbb8c15e3eb6",
            databaseURL: "https://freshbites-platform-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const ordersContainer = document.getElementById('orders-container');

        auth.onAuthStateChanged(user => {
            if (user) {
                // User is logged in, fetch their orders
                fetchUserOrders(user.uid);
            } else {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        function fetchUserOrders(userId) {
            const ordersRef = db.ref('orders');
            // This query fetches only the orders where the customerInfo/uid matches the current user's ID
            ordersRef.orderByChild('customerInfo/uid').equalTo(userId).on('value', (snapshot) => {
                const ordersData = snapshot.val();
                renderOrders(ordersData);
            }, (error) => {
                console.error("Error fetching user orders:", error);
                ordersContainer.innerHTML = '<p>Could not load your orders.</p>';
            });
        }

        function renderOrders(ordersData) {
            ordersContainer.innerHTML = '';
            if (!ordersData) {
                ordersContainer.innerHTML = '<p>You have not placed any orders yet.</p>';
                return;
            }

            const ordersArray = Object.keys(ordersData).map(key => ({ id: key, ...ordersData[key] }))
                .sort((a, b) => b.timestamp - a.timestamp); // Show newest orders first

            ordersArray.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';

                const statusClass = `status-${order.status.split(' ')[0].toLowerCase()}`; // e.g., 'status-pending'
                const itemsHtml = order.items.map(item => `<li>${item.quantity} x ${item.Name}</li>`).join('');

                card.innerHTML = `
                    <div class="order-header">
                        <h3>Order from ${order.shopName}</h3>
                        <span class="order-status ${statusClass}">${order.status}</span>
                    </div>
                    <p><strong>Total:</strong> â‚¹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Items:</strong></p>
                    <ul>${itemsHtml}</ul>
                `;
                ordersContainer.appendChild(card);
            });
        }
    </script>
</body>
</html>
