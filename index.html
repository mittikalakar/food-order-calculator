<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreshBites - Your Local Order Hub</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Lobster&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script>
    if (!localStorage.getItem('customerName') || !localStorage.getItem('customerPhone')) {
      // window.location.href = 'login.html';
    }
  </script>

  <style>
    /* --- 1. Core Setup & CSS Variables --- */
    :root {
      --font-body: 'Poppins', sans-serif;
      --font-heading: 'Lobster', cursive;
      --bg-color: #fff6f0;
      --surface-color: #fff8f4;
      --text-primary: #3a2e2e;
      --text-secondary: #7a5a54;
      --border-color: #f0d9d5;
      --primary: #ff6f61;
      --primary-dark: #e6564a;
      --shadow-color: rgba(230, 111, 97, 0.12);
      --shadow-color-strong: rgba(230, 111, 97, 0.22);
      --gradient-start: #fff8f4;
      --gradient-end: #fdf1ec;
    }
    body.dark {
      --bg-color: #3a2e2e;
      --surface-color: #4a3b38;
      --text-primary: #fff3f0;
      --text-secondary: #c9b4af;
      --border-color: #6e504c;
      --primary: #ff7b6e;
      --shadow-color: rgba(230, 123, 110, 0.25);
      --shadow-color-strong: rgba(230, 123, 110, 0.35);
      --gradient-start: #4a3b38;
      --gradient-end: #5a4a47;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; }

    /* --- 2. Main App Layout & Header --- */
    .app-layout { display: grid; grid-template-columns: 260px 1fr 340px; gap: 30px; max-width: 1600px; margin: 0 auto; padding: 20px; }
    .app-header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    .logo { font-family: var(--font-heading); font-size: 2rem; color: var(--primary); }
    .top-controls { display: flex; align-items: center; gap: 15px; }
    .control-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; display: grid; place-content: center; font-size: 1rem; transition: all 0.2s; }
    .control-btn:hover { color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-color); }

    /* --- 4. Sidebar (Categories) --- */
    .sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); }
    .sidebar h3 { font-size: 1.2rem; margin-bottom: 20px; }
    .category-nav ul { list-style: none; }
    .category-nav a { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; text-decoration: none; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; }
    .category-nav a:hover { background-color: var(--surface-color); color: var(--primary); }
    .category-nav a.active { background-color: var(--primary); color: #fff; }
    .category-nav a.active i { color: #fff; }
    .category-nav i { font-size: 1.1rem; width: 20px; text-align: center; color: var(--text-secondary); transition: color 0.2s; }
    
    /* --- 5. Main Content (Products & Search) --- */
    .product-grid-area { min-width: 0; }
    .search-bar { max-width: 600px; margin: 0 auto 20px auto; }
    .search-container { position: relative; flex-grow: 1; }
    .search-container .fa-magnifying-glass { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
    input[type="search"] { width: 100%; padding: 12px 20px 12px 48px; border-radius: 50px; border: 1px solid var(--border-color); background-color: var(--surface-color); font-size: 1rem; color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
    input[type="search"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
    
    #product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
    
    .product-card { background-color: var(--surface-color); border-radius: 16px; box-shadow: 0 4px 15px var(--shadow-color); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; opacity: 0; transform: translateY(20px); }
    .product-card.visible { opacity: 1; transform: translateY(0); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 20px 30px var(--shadow-color-strong); }

    .product-image-container { width: 100%; height: 200px; position: relative; overflow: hidden; cursor: grab; }
    .product-image-container:active { cursor: grabbing; }
    .carousel-track { display: flex; height: 100%; transition: transform 0.4s ease-out; }
    .carousel-slide { flex: 0 0 100%; width: 100%; height: 100%; }
    .carousel-slide img { width: 100%; height: 100%; object-fit: cover; user-select: none; pointer-events: none; }
    .carousel-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 5;}
    .dot { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(2px); cursor: pointer; transition: background-color 0.3s, transform 0.3s; }
    .dot.active { background-color: #fff; transform: scale(1.2); }

    .out-of-stock-overlay { position: absolute; inset: 0; background-color: rgba(255, 248, 244, 0.3); backdrop-filter: blur(4px) grayscale(80%); display: grid; place-content: center; z-index: 10; pointer-events: none; }
    body.dark .out-of-stock-overlay { background-color: rgba(74, 59, 56, 0.3); }
    .out-of-stock-overlay .badge { background-color: #e74c3c; color: white; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; transform: rotate(-10deg); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    .category-badge { position: absolute; top: 12px; left: 12px; background-color: color-mix(in srgb, var(--primary) 85%, black 10%); color: white; padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; z-index: 5; }

    .product-card .info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .product-card .name { font-weight: 600; font-size: 1.1rem; flex-grow: 1; margin-bottom: 12px; }
    .product-card .footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .product-card .price { font-weight: 700; font-size: 1.4rem; color: var(--primary); }
    
    .add-to-cart-btn, .quantity-control { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .add-to-cart-btn { background-color: var(--primary); color: #fff; padding: 10px 18px; font-size: 0.9rem; }
    .add-to-cart-btn:hover { background-color: var(--primary-dark); }
    .add-to-cart-btn[disabled] { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }

    .quantity-control { display: flex; align-items: center; gap: 8px; background-color: var(--primary); color: #fff; }
    .quantity-control button { background: none; border: none; color: #fff; font-size: 1.2rem; width: 35px; height: 38px; cursor: pointer; }
    .quantity-control span { font-size: 1.1rem; }

    .variant-selector { width: 100%; padding: 10px 40px 10px 14px; margin-bottom: 14px; border: 2px solid var(--border-color); border-radius: 16px; font-weight: 600; font-size: 1rem; appearance: none; background-repeat: no-repeat, repeat; background-position: right 14px center, 0 0; background-size: 20px 20px, 100%; cursor: pointer; transition: border-color 0.3s ease, box-shadow 0.3s ease; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-primary); background-color: var(--surface-color);
      background-image: url("data:image/svg+xml,%3Csvg fill='%23757575' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"), linear-gradient(to bottom, var(--gradient-start) 0%, var(--gradient-end) 100%);
    }
    .variant-selector:hover, .variant-selector:focus { border-color: var(--primary); box-shadow: 0 0 8px var(--primary); outline: none;
      background-image: url("data:image/svg+xml,%3Csvg fill='%23ff6f61' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"), linear-gradient(to bottom, var(--gradient-start) 0%, var(--gradient-end) 100%);
    }

    /* --- 6. Cart Area --- */
    .cart-area { position: sticky; top: 20px; height: calc(100vh - 40px); display: flex; flex-direction: column; }
    .cart-wrapper { background-color: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); display: flex; flex-direction: column; height: 100%; }
    .cart-header { padding: 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2rem; font-weight: 600; }
    .cart-items { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
    .cart-empty-msg { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 50px 20px; height: 100%; color: var(--text-secondary); }
    .cart-empty-msg i { font-size: 3.5rem; margin-bottom: 25px; color: var(--border-color); }
    .cart-empty-msg p { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 8px; }
    .cart-empty-msg span { font-size: 0.9rem; }
    body.dark .cart-empty-msg i { color: var(--border-color); }
    .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
    .cart-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
    .cart-item .details { flex-grow: 1; }
    .cart-footer { padding: 20px; border-top: 1px solid var(--border-color); background-color: var(--bg-color); border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;}
    .cart-total { display: flex; justify-content: space-between; font-weight: 600; font-size: 1.2rem; margin-bottom: 20px; }
    .cart-total span:last-child { color: var(--primary); }
    .cart-actions { display: flex; flex-direction: column; gap: 10px; }
    .action-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
    .whatsapp-btn { background-color: #25D366; color: #fff; }
    .secondary-btn { background-color: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color); }

    /* --- 7. All Modals & Mobile View --- */
    .hidden { display: none !important; }
    #no-results { text-align: center; padding: 40px; color: var(--text-secondary); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal.visible { opacity: 1; visibility: visible; display: flex; }
    .modal-content { background: var(--surface-color); padding: 25px 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px var(--shadow-color); transform: scale(0.9); transition: transform 0.3s; }
    .modal.visible .modal-content { transform: scale(1); }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-header h3 { font-size: 1.3rem; color: var(--text-primary); }
    #close-category-modal-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-secondary); line-height: 1; padding: 0 5px; }
    #category-modal-list { list-style: none; }
    #category-modal-list a { display: block; padding: 15px; border-radius: 8px; text-decoration: none; color: var(--text-primary); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: background-color 0.2s; }
    #category-modal-list a:hover { background-color: var(--surface-color); }
    #category-modal-list a.active { background-color: var(--primary); color: #fff; }

    #customer-info-modal h2 { margin-bottom: 20px; font-family: var(--font-heading); color: var(--primary); }
    #customer-info-modal label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary); text-align: left; }
    #customer-info-modal input { width: 100%; padding: 10px 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; color: var(--text-primary); background-color: var(--surface-color); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; }
    .modal-actions button { padding: 10px 18px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .modal-actions button[type="submit"] { background-color: var(--primary); color: #fff; }
    .modal-actions button[type="button"] { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-primary); }
    
    /* --- 8. Footer --- */
    .app-footer { grid-column: 1 / -1; text-align: center; padding: 40px 20px; margin-top: 40px; background-color: var(--surface-color); border-top: 1px solid var(--border-color); color: var(--text-secondary); transition: background-color 0.3s, border-color 0.3s; }
    .app-footer .tagline { margin-top: 8px; font-size: 0.9rem; }
    .social-links { display: flex; justify-content: center; gap: 25px; margin-top: 20px; }
    .social-links a { font-size: 1.4rem; color: var(--text-secondary); text-decoration: none; transition: color 0.2s, transform 0.2s; }
    .social-links a:hover { color: var(--primary); transform: translateY(-3px); }

    /* --- 9. Mobile Styles & Media Queries --- */
    #mobile-cart-btn, #mobile-cart-modal, .mobile-filter-bar { display: none; }
    @media (max-width: 1024px) {
      .app-layout { grid-template-columns: 1fr; padding: 10px; padding-bottom: 100px; }
      .sidebar, .cart-area, .search-bar { display: none; }
      .app-header { grid-column: auto; padding: 10px; }
      .logo { font-size: 1.5rem; }
      .mobile-filter-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
      #category-filter-btn { flex-shrink: 0; width: 50px; height: 50px; padding: 0; border: 1px solid var(--border-color); background-color: var(--surface-color); border-radius: 50%; cursor: pointer; font-size: 1.1rem; color: var(--text-secondary); display: grid; place-content: center; transition: all 0.2s ease; }
      #product-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
      #mobile-cart-btn { display: flex; justify-content: space-between; align-items: center; position: fixed; bottom: 15px; left: 15px; right: 15px; background-color: var(--primary); color: #fff; padding: 12px 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; transform: translateY(200%); animation: slide-in 0.5s forwards ease-out; }
      @keyframes slide-in { to { transform: translateY(0); } }
      #mobile-cart-modal { display: flex; align-items: flex-end; }
      #mobile-cart-modal.visible .cart-wrapper { transform: translateY(0); }
      #mobile-cart-modal .cart-wrapper { width: 100%; height: 85vh; border-bottom-left-radius: 0; border-bottom-right-radius: 0; transform: translateY(100%); transition: transform 0.4s ease-out; touch-action: pan-y; }
      .app-footer { margin-top: 20px; }
    }
  </style>
</head>
<body>

  <div class="app-layout">
    <header class="app-header">
      <div class="logo">Mitti Kalakar</div>
      <div class="top-controls">
        <button id="darkModeToggle" class="control-btn" title="Toggle Dark Mode"><i class="fa-solid fa-moon"></i></button>
        <button id="audioToggleBtn" class="control-btn" title="Play/Pause Music"><i class="fa-solid fa-volume-xmark"></i></button>
      </div>
    </header>

    <aside class="sidebar">
      <h3>Categories</h3>
      <nav class="category-nav" id="category-nav"></nav>
    </aside>

    <main class="product-grid-area">
      <div class="search-bar">
        <div class="search-container">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="search" id="productSearch" placeholder="Search for your favorite items...">
        </div>
      </div>
      <div class="mobile-filter-bar">
        <div class="search-container">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="search" id="productSearch-mobile" placeholder="Search for items...">
        </div>
        <button id="category-filter-btn" title="Filter by category"><i class="fa-solid fa-filter"></i></button>
      </div>
      <div id="product-grid"></div>
      <div id="no-results" class="hidden"><h3>No products found matching your search.</h3></div>
    </main>

    <aside class="cart-area" id="desktop-cart"></aside>

    <footer class="app-footer">
      <p>© 2024 Mitti Kalakar. All Rights Reserved.</p>
      <p class="tagline">Your local one-stop shop for fresh food and daily needs.</p>
      <div class="social-links">
        <a href="#" aria-label="Facebook" target="_blank"><i class="fab fa-facebook-f"></i></a>
        <a href="#" aria-label="Instagram" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://wa.me/917431059519" aria-label="WhatsApp" target="_blank"><i class="fab fa-whatsapp"></i></a>
      </div>
    </footer>
  </div>

  <div id="mobile-cart-btn" class="hidden"></div>
  <div id="mobile-cart-modal" class="modal"></div>
  
  <div id="category-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>All Categories</h3>
              <button id="close-category-modal-btn">×</button>
          </div>
          <ul id="category-modal-list"></ul>
      </div>
  </div>
  
  <div id="customer-info-modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Edit Your Info</h2>
      <form id="customerInfoForm">
        <label for="customerName">Name:</label>
        <input type="text" id="customerName" name="customerName" required />
        <label for="customerPhone">Phone Number:</label>
        <input type="tel" id="customerPhone" name="customerPhone" pattern="[0-9]{10}" placeholder="10-digit number" required />
        <label for="customerAddress">Address:</label>
        <input type="text" id="customerAddress" name="customerAddress" required />
        <label for="customerPincode">Pincode:</label>
        <input type="text" id="customerPincode" name="customerPincode" pattern="[0-9]{6}" placeholder="6-digit pincode" required />
        <label for="customerLandmark">Landmark:</label>
        <input type="text" id="customerLandmark" name="customerLandmark" />
        <div class="modal-actions">
          <button type="submit">Save</button>
          <button type="button" id="cancelCustomerInfoBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <audio id="bgAudio" loop><source src="https://www.dropbox.com/scl/fi/jgrk70tlbeub3m6hsgbud/Mor-Beena-Othe-Kon-Sure-PenduJatt.Com.Se.mp3?rlkey=7yil168sk6u7k9zcw97libva7&st=fpss14w6&dl=1" type="audio/mpeg" /></audio>

<script>
// --- 1. DATA (EXPANDED) ---
const ALL_PRODUCTS = [
  // Original Cooked Food
  { id: 'biriyani', name: 'Chicken Biriyani', variants: [ { label: 'Full Plate', price: 110 }, { label: 'Half Plate', price: 70 } ], inStock: true, images: ['https://www.sidechef.com/recipe/6df5d24c-24a1-417a-b317-f83d949447fc.jpg?d=1408x1120', 'https://glebekitchen.com/wp-content/uploads/2019/12/chickenbiryanibowltop.jpg'], category: 'Main Course' },
  { id: 'roll', name: 'Roll', variants: [ { label: 'Egg Roll', price: 40 }, { label: 'Chicken Roll', price: 55 } ], inStock: true, images: ['https://orders.popskitchen.in/storage/2024/09/image-299.png', 'https://www.licious.in/blog/wp-content/uploads/2022/11/shutterstock_1244343517.jpg'], category: 'Snacks' },
  { id: 'moglai', name: 'Moglai Paratha', price: 60, inStock: false, images: ['https://kandistores.com/app/sadmin/images/kalibariimagesmoglai.jpg'], category: 'Main Course' },
  { id: 'chicken_pakora', name: 'Chicken Pakora', variants: [ { label: '100 gm', price: 35 }, { label: '200 gm', price: 70 } ], inStock: true, images: ['https://i0.wp.com/southindianrecipes.in/wp-content/uploads/2021/09/Chicken-Pakora-Masala-Recipe.jpg?fit=800%2C800&ssl=1'], category: 'Snacks' },
  { id: 'momo', name: 'Momo', variants: [ { label: 'Chicken Momo', price: 50 }, { label: 'Veg Momo', price: 35 } ], inStock: true, images: ['https://images.aws.nestle.recipes/resized/a93335272b53b9f3b584a784c6981adc_momo_944_531.jpg', 'https://www.thespruceeats.com/thmb/Un_4d2ABi-OF-0d-dKdvT51s_4k=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/steamed-momos-w-spicy-tomato-chutney-2-1957383-a365405a415349319685a21235122f6d.jpg'], category: 'Snacks' },
  { id: 'chowmein', name: 'Chowmein', variants: [ { label: 'Egg Chowmein(Full)', price: 45 }, { label: 'Egg Chowmein(Half)', price: 25 }, { label: 'Egg Chicken Chowmein(Full)', price: 60 }, { label: 'Egg Chicken Chowmein(Half)', price: 40 } ], inStock: true, images: ['https://cdn.sanity.io/images/2r0kdewr/production/4ba5d16bc37976b03c4404e678bff07890b6e228-1000x668.jpg'], category: 'Snacks' },
  { id: 'singara', name: 'Singara (Samosa)', price: 10, inStock: true, images: ['https://www.sharmispassions.com/wp-content/uploads/2023/09/BengaliSamosa3.jpg'], category: 'Snacks' },

  // Packaged Snacks
  { id: 'lays_magic', name: "Lay's India's Magic Masala", price: 10, inStock: true, images: ['https://aapkabazar.co/_next/image?url=https%3A%2F%2Fimage.aapkabazar.co%2Fproduct%2F6779%2F1722405185865.png&w=3840&q=75'], category: 'Packaged Snacks' },
  { id: 'lays_classic', name: "Lay's Classic Salted", price: 10, inStock: true, images: ['https://aapkabazar.co/_next/image?url=https%3A%2F%2Fimage.aapkabazar.co%2Fproduct%2F6780%2F1687262271812.png&w=3840&q=75'], category: 'Packaged Snacks' },
  { id: 'bingo_mad_angles', name: 'Bingo! Mad Angles (Masala)', price: 10, inStock: true, images: ['https://www.jiomart.com/images/product/original/491334698/bingo-mad-angles-masti-masala-66-g-product-images-o491334698-p491334698-0-202307251147.jpg?im=Resize=(1000,1000)'], category: 'Packaged Snacks' },
  { id: 'haldirams_bhujia', name: "Haldiram's Bhujia Sev", price: 45, inStock: true, images: ['https://m.media-amazon.com/images/I/81GyZp6iA7L.jpg'], category: 'Packaged Snacks' },
  { id: 'goodday_cashew', name: 'Britannia Good Day (Cashew)', price: 10, inStock: true, images: ['https://rukminim2.flixcart.com/image/850/1000/xif0q/cookie-biscuit/s/e/v/-original-imagnvfb5z93zchz.jpeg?q=90&crop=false'], category: 'Packaged Snacks' },

  // Cold Drinks
  { id: 'thums_up', name: 'Thums Up', variants: [ { label: '250 ml', price: 20 }, { label: '750 ml', price: 40 } ], inStock: true, images: ['https://instamart-media-assets.swiggy.com/swiggy/image/upload/fl_lossy,f_auto,q_auto,h_600/vuwcqytnvajr4nz3zyj7'], category: 'Cold Drinks' },
  { id: 'sprite', name: 'Sprite Soft Drink', variants: [ { label: '250 ml', price: 20 }, { label: '750 ml', price: 40 } ], inStock: true, images: ['https://www.bbassets.com/media/uploads/p/l/251006_13-sprite-soft-drink-lime-flavoured.jpg'], category: 'Cold Drinks' },
  { id: 'coca_cola', name: 'Coca-Cola', variants: [ { label: '250 ml', price: 20 }, { label: '750 ml', price: 40 } ], inStock: true, images: ['https://www.jiomart.com/images/product/original/490809295/coca-cola-750-ml-product-images-o490809295-p490809295-0-202203151921.jpg?im=Resize=(1000,1000)'], category: 'Cold Drinks' },
  { id: 'daab', name: 'Daab (Tender Coconut)', price: 55, inStock: true, images: ['https://blog.gourmetdelight.in/wp-content/uploads/2019/12/shutterstock_1184399770-1.jpg'], category: 'Cold Drinks' },

  // Sweets & Desserts
  { id: 'rasgulla', name: 'Rasgulla (1 pc)', price: 10, inStock: true, images: ['https://panjisweets.com/cdn/shop/products/120209_PanjiSweets_Food_Rasgulla_600x600_crop_center.jpg?v=1606001447'], category: 'Sweets & Desserts'},
  { id: 'mishti_doi', name: 'Mishti Doi (100g Cup)', price: 35, inStock: true, images: ['https://www.bigbasket.com/media/uploads/p/l/40073557_2-mother-dairy-mishti-doi.jpg'], category: 'Sweets & Desserts' },
  { id: 'dairy_milk', name: 'Cadbury Dairy Milk', price: 20, inStock: true, images: ['https://www.jiomart.com/images/product/original/490003923/cadbury-dairy-milk-chocolate-bar-24-g-product-images-o490003923-p490003923-0-202309251803.jpg'], category: 'Sweets & Desserts' },
  
  // Grocery
  { id: 'sugar', name: 'Sugar (Chini)', price: 45, inStock: true, images: ['https://m.media-amazon.com/images/I/61aG3yerFzL.jpg', 'https://media.istockphoto.com/id/1287871932/photo/granulated-white-cane-sugar-in-a-sack-with-a-scoop.jpg?s=612x612&w=0&k=20&c=BTRAQen1dZVsLhOjSZV50mMCyGM1xz9y2nVHCmpWlhg='], category: 'Grocery' },
  { id: 'fortune_mustard_oil', name: 'Fortune Mustard Oil (Kachi Ghani)', variants: [ { label: '500 ml', price: 95 }, { label: '1 Ltr', price: 180 } ], inStock: true, images: ['https://m.media-amazon.com/images/I/71wVU7pgwAL._UF894,1000_QL80_.jpg'], category: 'Grocery' },
  { id: 'aashirvaad_atta', name: 'Aashirvaad Shudh Chakki Atta', variants: [ { label: '1 kg', price: 58 }, { label: '5 kg', price: 275 } ], inStock: true, images: ['https://www.jiomart.com/images/product/original/490001441/aashirvaad-shudh-chakki-atta-1-kg-product-images-o490001441-p490001441-0-202306031732.jpg'], category: 'Grocery' },
  { id: 'tata_salt', name: 'Tata Salt (Iodized)', price: 28, inStock: true, images: ['https://www.jiomart.com/images/product/original/490000041/tata-salt-iodized-1-kg-product-images-o490000041-p490000041-0-202307241240.jpg'], category: 'Grocery' },
  { id: 'red_label_tea', name: 'Brooke Bond Red Label Tea (250g)', price: 140, inStock: true, images: ['https://m.media-amazon.com/images/I/71D05o2F07L.jpg'], category: 'Grocery' },
  { id: 'amul_ghee', name: 'Amul Pure Ghee', variants: [ { label: '200 ml', price: 140 }, { label: '500 ml', price: 335 } ], inStock: true, images: ['https://www.amul.com/files/products/cow-ghee-1-litre-pack.png'], category: 'Grocery' },
  { id: 'amul_taaza_milk', name: 'Amul Taaza Toned Milk (500ml)', price: 34, inStock: true, images: ['https://www.jiomart.com/images/product/original/490000062/amul-taaza-toned-milk-500-ml-carton-product-images-o490000062-p490000062-0-202203151918.jpg'], category: 'Grocery' },
  { id: 'paneer', name: 'Fresh Paneer (200g)', price: 90, inStock: true, images: ['https://static.grocist.com/images/products/full/229.2.jpg'], category: 'Grocery' },
  { id: 'eggs', name: 'Eggs (6 pcs)', price: 42, inStock: true, images: ['https://cdn.grofers.com/cdn-cgi/image/f=auto,fit=scale-down,q=70,metadata=none,w=1080/app/images/products/sliding_image/438781a.jpg'], category: 'Grocery' },
  { id: 'onions', name: 'Onion (Pyaj) 1kg', price: 40, inStock: true, images: ['https://www.bigbasket.com/media/uploads/p/l/10000148_30-fresho-onion.jpg'], category: 'Grocery' },
  { id: 'potatoes', name: 'Potato (Aloo) 1kg', price: 30, inStock: true, images: ['https://www.bigbasket.com/media/uploads/p/l/10000159_27-fresho-potato.jpg'], category: 'Grocery' },
  { id: 'tomatoes', name: 'Tomato (1kg)', price: 50, inStock: true, images: ['https://www.bigbasket.com/media/uploads/p/l/10000200_17-fresho-tomato-hybrid.jpg'], category: 'Grocery' },

  // Puja Items
  { id: 'belpatra', name: 'Belpatra (বেলপত্র)', price: 2, inStock: true, images: ['https://m.media-amazon.com/images/I/51R2qP9jKLL._UF1000,1000_QL80_.jpg'], category: 'Puja Items' },
  { id: 'agarbatti', name: 'Mangaldeep Agarbatti', price: 20, inStock: true, images: ['https://www.itcportal.com/brands-microsite/images/mangaldeep/mangaldeep-large.png'], category: 'Puja Items' },
  { id: 'camphor', name: 'Camphor (Kapur)', price: 30, inStock: true, images: ['https://4.imimg.com/data4/GT/WE/MY-1077699/camphor-tablets-500x500.jpg'], category: 'Puja Items' },
];
const CATEGORIES = {
    'All': 'fa-solid fa-store', 'Main Course': 'fa-solid fa-bowl-food', 'Snacks': 'fa-solid fa-cookie-bite',
    'Sweets & Desserts': 'fa-solid fa-ice-cream', 'Cold Drinks': 'fa-solid fa-martini-glass',
    'Packaged Snacks': 'fa-solid fa-bag-shopping', 'Grocery': 'fa-solid fa-carrot', 'Puja Items': 'fa-solid fa-om'
};

let cart = [];
let activeFilter = 'All';
let uiState = { selectedVariants: {} };

const productGrid = document.getElementById('product-grid');
const categoryNav = document.getElementById('category-nav');
const desktopCartContainer = document.getElementById('desktop-cart');
const mobileCartModalContainer = document.getElementById('mobile-cart-modal');
const mobileCartBtn = document.getElementById('mobile-cart-btn');
const productSearchDesktop = document.getElementById('productSearch');
const productSearchMobile = document.getElementById('productSearch-mobile');
const noResultsDiv = document.getElementById('no-results');
const categoryFilterBtn = document.getElementById('category-filter-btn');
const categoryModal = document.getElementById('category-modal');
const categoryModalList = document.getElementById('category-modal-list');
const customerInfoModal = document.getElementById('customer-info-modal');
const darkModeToggle = document.getElementById('darkModeToggle');
const audio = document.getElementById('bgAudio');
const audioBtn = document.getElementById('audioToggleBtn');

const cardObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
        }
    });
}, { threshold: 0.1 });


function renderProducts(filter = 'All', searchTerm = '') {
  productGrid.innerHTML = '';
  let hasResults = false;
  const lowerCaseSearchTerm = searchTerm.toLowerCase();
  ALL_PRODUCTS.forEach(product => {
    const categoryMatch = filter === 'All' || product.category === filter;
    const searchMatch = product.name.toLowerCase().includes(lowerCaseSearchTerm);
    if (categoryMatch && searchMatch) {
      hasResults = true;
      const card = document.createElement('div');
      card.className = 'product-card';
      card.dataset.productId = product.id;
      const hasVariants = product.variants && product.variants.length > 0;
      const selectedVariantIndex = uiState.selectedVariants[product.id] || 0;
      let displayedPrice = product.price || 0;
      if (hasVariants) { displayedPrice = product.variants[selectedVariantIndex].price; }
      const variantSelectorHTML = hasVariants ? `<select class="variant-selector" data-product-id="${product.id}" aria-label="Select variant for ${product.name}">
          ${product.variants.map((v, i) => `<option value="${i}" ${i === selectedVariantIndex ? 'selected' : ''}>${v.label} - ₹${v.price}</option>`).join('')}
        </select>` : '';
      const buttonHTML = getButtonHTML(product, selectedVariantIndex);
      const outOfStockOverlay = !product.inStock ? `<div class="out-of-stock-overlay"><span class="badge">OUT OF STOCK</span></div>` : '';
      card.innerHTML = `
        ${outOfStockOverlay}
        <div class="category-badge">${product.category}</div>
        <div class="product-image-container">
            <div class="carousel-track">
                ${product.images.map(imgUrl => `<div class="carousel-slide"><img src="${imgUrl}" alt="${product.name}" loading="lazy"></div>`).join('')}
            </div>
            ${product.images.length > 1 ? `<div class="carousel-dots">${product.images.map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}" data-index="${i}"></div>`).join('')}</div>` : ''}
        </div>
        <div class="info">
          <p class="name">${product.name}</p>
          ${variantSelectorHTML}
          <div class="footer">
            <span class="price">₹${displayedPrice}</span>
            <div class="action-wrapper">${buttonHTML}</div>
          </div>
        </div>
      `;
      productGrid.appendChild(card);
      cardObserver.observe(card);
      if (product.images.length > 1) initProductCarousel(card);
    }
  });
  noResultsDiv.classList.toggle('hidden', hasResults);
}

function getButtonHTML(product, selectedVariantIndex = 0) {
    if (!product.inStock) return `<button class="add-to-cart-btn" disabled>Out of Stock</button>`;
    const cardElement = document.querySelector(`[data-product-id="${product.id}"]`) || document.createElement('div');
    const { variantLabel } = getSelectedVariantInfo({ closest: () => cardElement }, product);
    const itemInCart = cart.find(item => item.id === product.id && item.variantLabel === variantLabel);
    if (itemInCart) {
        return `<div class="quantity-control"><button onclick="handleQuantityChange(this, '${product.id}', -1)">-</button><span>${itemInCart.quantity}</span><button onclick="handleQuantityChange(this, '${product.id}', 1)">+</button></div>`;
    } else {
        return `<button class="add-to-cart-btn" onclick="handleAddToCart(this, '${product.id}')">Add</button>`;
    }
}

function renderCategories() {
    const desktopList = document.createElement('ul');
    categoryModalList.innerHTML = ''; 
    Object.entries(CATEGORIES).forEach(([name, iconClass]) => {
        const isActive = name === activeFilter;
        const linkHTML = `<a href="#" class="${isActive ? 'active' : ''}" data-category="${name}"><i class="${iconClass}"></i><span>${name}</span></a>`;
        const li = document.createElement('li');
        li.innerHTML = linkHTML;
        desktopList.appendChild(li);
        categoryModalList.appendChild(li.cloneNode(true));
    });
    categoryNav.innerHTML = '';
    categoryNav.appendChild(desktopList);
}

function renderCart() {
    const { items, total, count } = calculateCart();
    const cartHTML = `
        <div class="cart-wrapper">
            <div class="cart-header">Your Order</div>
            <div class="cart-items">
                ${items.length === 0 ? `<div class="cart-empty-msg"><i class="fa-solid fa-cart-shopping"></i><p>Your cart is empty.</p><span>Add items to get started!</span></div>` : items.map(item => `
                    <div class="cart-item">
                        <img src="${item.images[0]}" alt="${item.name}">
                        <div class="details">
                          <p class="name">${item.name} ${item.variantLabel ? `(${item.variantLabel})` : ''}</p>
                          <p class="price">₹${item.price} x ${item.quantity} = ₹${item.price * item.quantity}</p>
                        </div>
                        <div class="quantity-control">
                            <button onclick="handleQuantityChange(this, '${item.id}', -1, '${item.variantLabel}')">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="handleQuantityChange(this, '${item.id}', 1, '${item.variantLabel}')">+</button>
                        </div>
                    </div>`).join('')}
            </div>
            ${items.length > 0 ? `
            <div class="cart-footer">
                <div class="cart-total"><span>Grand Total</span><span>₹${total}</span></div>
                <div class="cart-actions">
                    <a href="#" id="whatsapp-order-btn" class="action-btn whatsapp-btn" target="_blank"><i class="fab fa-whatsapp"></i> Order on WhatsApp</a>
                    <button class="action-btn secondary-btn" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> Download Bill</button>
                    <button class="action-btn secondary-btn" onclick="showCustomerInfoModal()"><i class="fa-solid fa-user-pen"></i> Edit My Info</button>
                </div>
            </div>` : ''}
        </div>`;
    desktopCartContainer.innerHTML = cartHTML;
    mobileCartModalContainer.innerHTML = cartHTML;
    mobileCartBtn.innerHTML = `<span class="item-count"><i class="fa-solid fa-bag-shopping"></i> ${count}</span><span>View Your Order</span><span class="total">₹${total}</span>`;
    mobileCartBtn.classList.toggle('hidden', items.length === 0);
}

function handleAddToCart(buttonElement, productId) {
    const product = ALL_PRODUCTS.find(p => p.id === productId);
    if (!product || !product.inStock) return;
    const { price, variantLabel } = getSelectedVariantInfo(buttonElement, product);
    const existingIndex = cart.findIndex(item => item.id === productId && item.variantLabel === variantLabel);
    if (existingIndex > -1) {
        cart[existingIndex].quantity++;
    } else {
        cart.push({ ...product, price, variantLabel, quantity: 1 });
    }
    rerenderAll();
}

function handleQuantityChange(buttonElement, productId, change, variantLabelFromCart = null) {
    let variantLabel = variantLabelFromCart;
    if (variantLabel === null) {
        const product = ALL_PRODUCTS.find(p => p.id === productId);
        variantLabel = getSelectedVariantInfo(buttonElement, product).variantLabel;
    }
    const itemIndex = cart.findIndex(item => item.id === productId && item.variantLabel === variantLabel);
    if (itemIndex > -1) {
        cart[itemIndex].quantity += change;
        if (cart[itemIndex].quantity <= 0) cart.splice(itemIndex, 1);
    }
    rerenderAll();
}

function getSelectedVariantInfo(buttonElement, product) {
    let price = product.price;
    let variantLabel = '';
    if (product.variants && product.variants.length > 0) {
        const card = buttonElement.closest('.product-card');
        const selector = card.querySelector('.variant-selector');
        const variantIndex = selector ? parseInt(selector.value, 10) : 0;
        price = product.variants[variantIndex].price;
        variantLabel = product.variants[variantIndex].label;
    }
    return { price, variantLabel };
}

function handleCategoryChange(newCategory) { activeFilter = newCategory; rerenderAll(); categoryModal.classList.remove('visible'); }
function calculateCart() { const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); const count = cart.reduce((sum, item) => sum + item.quantity, 0); return { items: cart, total, count }; }
function rerenderAll() { const searchTerm = window.innerWidth <= 1024 ? productSearchMobile.value : productSearchDesktop.value; renderProducts(activeFilter, searchTerm); renderCategories(); renderCart(); }
function downloadPDF() { /* Your existing downloadPDF logic */ }
function showCustomerInfoModal() { customerInfoModal.classList.add('visible'); /* Your existing populate fields logic */ }
function hideCustomerInfoModal() { customerInfoModal.classList.remove('visible'); }

function initProductCarousel(cardElement) {
    const track = cardElement.querySelector('.carousel-track'); if (!track) return;
    const slides = Array.from(track.children); const dotsNav = cardElement.querySelector('.carousel-dots'); const dots = dotsNav ? Array.from(dotsNav.children) : [];
    let currentIndex = 0, autoPlayInterval, isDragging = false, startPos = 0, currentTranslate = 0, prevTranslate = 0;
    const goToSlide = (index) => { if (index < 0 || index >= slides.length) return; const slideWidth = slides[0].getBoundingClientRect().width; track.style.transition = 'transform 0.4s ease-out'; track.style.transform = `translateX(-${slideWidth * index}px)`; currentIndex = index; if(dotsNav) dots.forEach((dot, idx) => dot.classList.toggle('active', idx === currentIndex)); };
    const startAutoPlay = () => { stopAutoPlay(); autoPlayInterval = setInterval(() => goToSlide((currentIndex + 1) % slides.length), 4000); };
    const stopAutoPlay = () => clearInterval(autoPlayInterval);
    const getPositionX = e => e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
    const dragStart = e => { isDragging = true; startPos = getPositionX(e); prevTranslate = -currentIndex * slides[0].getBoundingClientRect().width; track.style.transition = 'none'; stopAutoPlay(); };
    const drag = e => { if (isDragging) { currentTranslate = prevTranslate + getPositionX(e) - startPos; track.style.transform = `translateX(${currentTranslate}px)`; } };
    const dragEnd = () => { if (!isDragging) return; isDragging = false; const movedBy = currentTranslate - prevTranslate; if (movedBy < -100 && currentIndex < slides.length - 1) currentIndex++; if (movedBy > 100 && currentIndex > 0) currentIndex--; goToSlide(currentIndex); startAutoPlay(); };
    cardElement.querySelector('.product-image-container').addEventListener('mousedown', dragStart);
    cardElement.querySelector('.product-image-container').addEventListener('touchstart', dragStart, { passive: true });
    window.addEventListener('mousemove', drag); window.addEventListener('touchmove', drag, { passive: true });
    window.addEventListener('mouseup', dragEnd); window.addEventListener('touchend', dragEnd);
    cardElement.addEventListener('mouseenter', stopAutoPlay); cardElement.addEventListener('mouseleave', startAutoPlay);
    if(dotsNav) dots.forEach(dot => dot.addEventListener('click', () => goToSlide(parseInt(dot.dataset.index))));
    startAutoPlay();
}

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const categoryFromURL = urlParams.get('category');
    if (categoryFromURL && Object.keys(CATEGORIES).includes(categoryFromURL)) { activeFilter = categoryFromURL; }
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('variant-selector')) {
        const card = e.target.closest('.product-card'); const productId = card.dataset.productId; const newIndex = parseInt(e.target.value, 10);
        uiState.selectedVariants[productId] = newIndex; const product = ALL_PRODUCTS.find(p => p.id === productId);
        card.querySelector('.price').textContent = `₹${product.variants[newIndex].price}`;
        card.querySelector('.action-wrapper').innerHTML = getButtonHTML(product, newIndex);
      }
    });
    rerenderAll();
    categoryNav.addEventListener('click', e => { e.preventDefault(); const link = e.target.closest('a'); if (link) handleCategoryChange(link.dataset.category); });
    categoryFilterBtn.addEventListener('click', () => categoryModal.classList.add('visible'));
    document.getElementById('close-category-modal-btn').addEventListener('click', () => categoryModal.classList.remove('visible'));
    categoryModal.addEventListener('click', e => { if (e.target.id === 'category-modal') categoryModal.classList.remove('visible'); const link = e.target.closest('a'); if(link) { e.preventDefault(); handleCategoryChange(link.dataset.category); } });
    function handleSearch() { rerenderAll(); }
    productSearchDesktop.addEventListener('input', handleSearch); productSearchMobile.addEventListener('input', handleSearch);
    mobileCartBtn.addEventListener('click', () => mobileCartModalContainer.classList.add('visible'));
    mobileCartModalContainer.addEventListener('click', e => { if (e.target.id === 'mobile-cart-modal') mobileCartModalContainer.classList.remove('visible'); });
    darkModeToggle.addEventListener('click', () => { document.body.classList.toggle('dark'); darkModeToggle.innerHTML = document.body.classList.contains('dark') ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>'; });
    audioBtn.addEventListener('click', () => { if(audio.paused) { audio.play().catch(e => console.log("Audio play blocked.")); audioBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>'; } else { audio.pause(); audioBtn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>'; } });
    const customerInfoForm = document.getElementById('customerInfoForm');
    customerInfoForm.addEventListener('submit', (e) => { e.preventDefault(); hideCustomerInfoModal(); /* ... your save logic ... */ });
    document.getElementById('cancelCustomerInfoBtn').addEventListener('click', hideCustomerInfoModal);
});
</script>

</body>
</html>
