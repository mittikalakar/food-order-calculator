<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreshBites - Your Local Order Hub</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&family=Lobster&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <script>
    if (!localStorage.getItem('customerName') || !localStorage.getItem('customerPhone')) {
      window.location.href = 'login.html';
    }
  </script>

  <style>
    :root {
      --font-body: 'Poppins', sans-serif; --font-heading: 'Lobster', cursive; --bg-color: #fff6f0; --surface-color: #fff8f4; --text-primary: #3a2e2e; --text-secondary: #7a5a54; --border-color: #f0d9d5; --primary: #ff6f61; --primary-dark: #e6564a; --shadow-color: rgba(230, 111, 97, 0.12); --shadow-color-strong: rgba(230, 111, 97, 0.22); --gradient-start: #fff8f4; --gradient-end: #fdf1ec;
    }
    body.dark {
      --bg-color: #3a2e2e; --surface-color: #4a3b38; --text-primary: #fff3f0; --text-secondary: #c9b4af; --border-color: #6e504c; --primary: #ff7b6e; --shadow-color: rgba(230, 123, 110, 0.25); --shadow-color-strong: rgba(230, 123, 110, 0.35); --gradient-start: #4a3b38; --gradient-end: #5a4a47;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; }
    .app-layout { display: grid; grid-template-columns: 260px 1fr 340px; gap: 30px; max-width: 1600px; margin: 0 auto; padding: 20px; }
    .app-header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    .logo { font-family: var(--font-heading); font-size: 2rem; color: var(--primary); }
    .top-controls { display: flex; align-items: center; gap: 15px; }
    .control-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; display: grid; place-content: center; font-size: 1rem; transition: all 0.2s; }
    .control-btn:hover { color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-color); }
    .sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); }
    .sidebar h3 { font-size: 1.2rem; margin-bottom: 20px; }
    .category-nav ul { list-style: none; }
    .category-nav a { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; text-decoration: none; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; }
    .category-nav a:hover { background-color: var(--surface-color); color: var(--primary); }
    .category-nav a.active { background-color: var(--primary); color: #fff; }
    .category-nav a.active i { color: #fff; }
    .category-nav i { font-size: 1.1rem; width: 20px; text-align: center; color: var(--text-secondary); transition: color 0.2s; }
    .product-grid-area { min-width: 0; }
    .search-bar { max-width: 600px; margin: 0 auto 20px auto; }
    .search-container { position: relative; flex-grow: 1; }
    .search-container .fa-magnifying-glass { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
    input[type="search"] { width: 100%; padding: 12px 20px 12px 48px; border-radius: 50px; border: 1px solid var(--border-color); background-color: var(--surface-color); font-size: 1rem; color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
    input[type="search"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
    #product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
    .product-card { background-color: var(--surface-color); border-radius: 16px; box-shadow: 0 4px 15px var(--shadow-color); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; opacity: 0; transform: translateY(20px); }
    .product-card.visible { opacity: 1; transform: translateY(0); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 20px 30px var(--shadow-color-strong); }
    .product-image-container { width: 100%; height: 200px; position: relative; overflow: hidden; cursor: grab; }
    .product-image-container:active { cursor: grabbing; }
    .carousel-track { display: flex; height: 100%; transition: transform 0.4s ease-out; }
    .carousel-slide { flex: 0 0 100%; width: 100%; height: 100%; }
    .carousel-slide img { width: 100%; height: 100%; object-fit: cover; user-select: none; pointer-events: none; }
    .out-of-stock-overlay { position: absolute; inset: 0; background-color: rgba(255, 248, 244, 0.5); backdrop-filter: blur(1px) grayscale(50%); display: grid; place-content: center; z-index: 10; pointer-events: none; }
    .category-icon-badge { position: absolute; top: 12px; left: 12px; width: 36px; height: 36px; background-color: color-mix(in srgb, var(--primary) 85%, black 10%); color: white; border-radius: 50%; font-size: 0.9rem; z-index: 5; text-decoration: none; transition: transform 0.2s ease-in-out; display: grid; place-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); }
    .product-card .info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .product-card .name { font-weight: 600; font-size: 1.1rem; flex-grow: 1; margin-bottom: 12px; }
    .product-card .footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .product-card .price { font-weight: 700; font-size: 1.4rem; color: var(--primary); }
    .add-to-cart-btn, .quantity-control { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .add-to-cart-btn { background-color: var(--primary); color: #fff; padding: 10px 18px; font-size: 0.9rem; }
    .quantity-control { display: flex; align-items: center; gap: 8px; background-color: var(--primary); color: #fff; }
    .quantity-control button { background: none; border: none; color: #fff; font-size: 1.2rem; width: 35px; height: 38px; cursor: pointer; }
    .quantity-control span { font-size: 1.1rem; }
    .cart-area { position: sticky; top: 20px; height: calc(100vh - 40px); display: flex; flex-direction: column; }
    .cart-wrapper { background-color: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); display: flex; flex-direction: column; height: 100%; }
    .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2rem; font-weight: 600; }
    .cart-items { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
    .cart-empty-msg { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 50px 20px; height: 100%; color: var(--text-secondary); }
    .cart-empty-msg i { font-size: 3.5rem; margin-bottom: 25px; color: var(--border-color); }
    .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
    .cart-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
    .cart-item .details { flex-grow: 1; }
    .cart-footer { padding: 20px; border-top: 1px solid var(--border-color); }
    .cart-total { display: flex; justify-content: space-between; font-weight: 600; font-size: 1.2rem; margin-bottom: 20px; }
    .cart-total span:last-child { color: var(--primary); }
    .cart-actions { display: flex; flex-direction: column; gap: 10px; }
    .action-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
    .whatsapp-btn { background-color: #25D366; color: #fff; }
    .secondary-btn { background-color: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color); }
    .location-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--primary); background-color: transparent; color: var(--primary); font-size: 1.2rem; cursor: pointer; display: grid; place-content: center; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .location-btn:hover { background-color: var(--primary); color: #fff; transform: scale(1.05); }
    .location-btn.loading i { animation: fa-spin 1.5s infinite linear; }
    .location-btn.success { background-color: #25D366; border-color: #25D366; color: #fff; cursor: default; }
    .location-btn.error { border-color: #d9534f; color: #d9534f; }
    .location-status-msg, .pincode-status-msg { padding: 10px; margin-bottom: 15px; border-radius: 8px; text-align: center; font-weight: 500; font-size: 0.9rem; }
    .location-status-msg.idle { background-color: color-mix(in srgb, var(--primary) 20%, transparent); border: 1px solid var(--primary); }
    .location-status-msg.success, .pincode-status-msg.success { background-color: color-mix(in srgb, #25D366 20%, transparent); border: 1px solid #25D366; }
    .location-status-msg.error, .pincode-status-msg.error { background-color: color-mix(in srgb, #d9534f 20%, transparent); border: 1px solid #d9534f; }
    .whatsapp-btn[disabled] { background-color: #90E0A9; color: #fff; opacity: 0.7; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="app-layout">
    <header class="app-header">
      <div class="logo">FreshBites</div>
      <div class="top-controls">
        <button id="darkModeToggle" class="control-btn" title="Toggle Dark Mode"><i class="fa-solid fa-moon"></i></button>
      </div>
    </header>
    <aside class="sidebar"><h3 class="notranslate">Categories</h3><nav class="category-nav" id="category-nav"></nav></aside>
    <main class="product-grid-area">
      <div class="search-bar"><div class="search-container"><i class="fa-solid fa-magnifying-glass"></i><input type="search" id="productSearch" placeholder="Search for your favorite items..."></div></div>
      <div id="product-grid"></div>
    </main>
    <aside class="cart-area" id="desktop-cart"></aside>
  </div>
  <div id="customer-info-modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Edit Your Info</h2>
      <form id="customerInfoForm">
        <label for="customerName">Name:</label><input type="text" id="customerName" name="customerName" required />
        <label for="customerPhone">Phone Number:</label><input type="tel" id="customerPhone" name="customerPhone" pattern="[0-9]{10}" placeholder="10-digit number" required />
        <label for="customerAddress">Address:</label><input type="text" id="customerAddress" name="customerAddress" required />
        <label for="customerPincode">Pincode:</label><input type="text" id="customerPincode" name="customerPincode" pattern="[0-9]{6}" placeholder="6-digit pincode" required />
        <label for="customerLandmark">Landmark:</label><input type="text" id="customerLandmark" name="customerLandmark" />
        <div class="modal-actions"><button type="submit">Save</button><button type="button" id="cancelCustomerInfoBtn">Cancel</button></div>
      </form>
    </div>
  </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // --- START: PASTE YOUR COMPLETE FIREBASE CONFIG OBJECT HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyA5_f3mtvEWeBNDzVyQtI22rXn3lpLeOjE", // Replace with your actual key
        authDomain: "freshbites-platform.firebaseapp.com",
        projectId: "freshbites-platform",
        storageBucket: "freshbites-platform.appspot.com",
        messagingSenderId: "89904601475",
        appId: "1:89904601475:web:791328b498cbb8c15e3eb6",
        databaseURL: "https://freshbites-platform-default-rtdb.firebaseio.com" // Replace with your actual Database URL
    };
    // --- END: PASTE YOUR FIREBASE CONFIG OBJECT HERE ---

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Global variables ---
    let ALL_PRODUCTS = [];
    let cart = [];
    let activeFilter = 'All';
    let uiState = { selectedVariants: {} };
    const CATEGORIES = { 'All': 'fa-solid fa-store', 'Main Course': 'fa-solid fa-bowl-food', 'Snacks': 'fa-solid fa-cookie-bite', 'Sweets & Desserts': 'fa-solid fa-ice-cream', 'Cold Drinks': 'fa-solid fa-martini-glass', 'Packaged Snacks': 'fa-solid fa-bag-shopping', 'Grocery': 'fa-solid fa-carrot', 'Puja Items': 'fa-solid fa-om' };
    const FILTER_GROUPS = { food: ['Main Course', 'Snacks', 'Sweets & Desserts', 'Cold Drinks'], grocery: ['Grocery', 'Packaged Snacks'], puja: ['Puja Items'] };
    const VALID_PINCODES = ['743391', '743372'];
    let locationState = { status: 'idle', data: null };
    let pincodeState = { isValid: false, message: '' };

    // --- DOM Elements ---
    const productGrid = document.getElementById('product-grid');
    const categoryNav = document.getElementById('category-nav');
    const desktopCartContainer = document.getElementById('desktop-cart');
    const customerInfoModal = document.getElementById('customer-info-modal');
    const darkModeToggle = document.getElementById('darkModeToggle');
    
    // --- Core Function: Fetch and process data from Firebase ---
    function fetchAllProducts() {
        productGrid.innerHTML = '<p style="text-align: center; font-size: 1.2rem; color: var(--text-secondary);">Loading delicious items...</p>';
        db.ref().on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !data.products || !data.vendors) {
                productGrid.innerHTML = '<p>No products available right now.</p>';
                ALL_PRODUCTS = [];
                rerenderAll();
                return;
            }
            const openVendors = {};
            Object.keys(data.vendors).forEach(vendorId => {
                const vendor = data.vendors[vendorId];
                if (vendor.ShopStatus === 'Open') {
                    openVendors[vendorId] = vendor;
                }
            });
            ALL_PRODUCTS = Object.keys(data.products).map(key => {
                const product = data.products[key];
                product.id = key;
                if (typeof product.Images === 'string') {
                    product.Images = [product.Images];
                }
                return product;
            }).filter(product => openVendors[product.VendorID] && product.InStock === true);
            rerenderAll();
        }, (error) => {
            console.error("Firebase Read Failed: ", error);
            productGrid.innerHTML = '<p style="text-align: center; font-size: 1.2rem; color: #d9534f;">Could not load products. Please try again later.</p>';
        });
    }

    // --- Page Render Functions ---
    function rerenderAll() {
        const searchTerm = document.getElementById('productSearch').value;
        renderProducts(activeFilter, searchTerm);
        renderCategories();
        renderCart();
    }

    function renderProducts(filter = 'All', searchTerm = '') {
        productGrid.innerHTML = '';
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        const filteredProducts = ALL_PRODUCTS.filter(product => {
            const categoryMatch = filter === 'All' || product.Category === filter;
            const searchMatch = product.Name.toLowerCase().includes(lowerCaseSearchTerm);
            return categoryMatch && searchMatch;
        });

        if (filteredProducts.length === 0) {
            productGrid.innerHTML = '<p>No products found.</p>';
            return;
        }

        filteredProducts.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;
            const buttonHTML = getButtonHTML(product);
            const categoryIconClass = CATEGORIES[product.Category] || 'fa-solid fa-tag';
            card.innerHTML = `
                <div class="product-image-container">
                    <a href="#" class="category-icon-badge" title="${product.Category}"><i class="${categoryIconClass}"></i></a>
                    <div class="carousel-track"><img src="${(product.Images || [])[0]}" alt="${product.Name}" loading="lazy"></div>
                    ${!product.InStock ? '<div class="out-of-stock-overlay"><span class="badge">Out Of<br>Stock</span></div>' : ''}
                </div>
                <div class="info">
                    <p class="name">${product.Name}</p>
                    <p class="shop-name" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: -8px; margin-bottom: 8px;">by ${product.ShopName || 'FreshBites'}</p>
                    <div class="footer">
                        <span class="price">₹${product.Price.toFixed(2)}</span>
                        <div class="action-wrapper">${buttonHTML}</div>
                    </div>
                </div>`;
            productGrid.appendChild(card);
        });
    }

    function renderCategories() {
        const list = document.createElement('ul');
        Object.entries(CATEGORIES).forEach(([name, iconClass]) => {
            const isActive = name === activeFilter;
            const li = document.createElement('li');
            li.innerHTML = `<a href="#" class="${isActive ? 'active' : ''}" data-category="${name}"><i class="${iconClass}"></i><span>${name}</span></a>`;
            list.appendChild(li);
        });
        categoryNav.innerHTML = '<h3>Categories</h3>';
        categoryNav.appendChild(list);
    }

    function renderCart() {
        const { items, total, count } = calculateCart();
        validatePincode();
        let locationButtonHTML = '';
        if (items.length > 0) {
            switch(locationState.status) {
                case 'loading': locationButtonHTML = `<button class="location-btn loading" title="Fetching location..."><i class="fa-solid fa-spinner fa-spin"></i></button>`; break;
                case 'success': locationButtonHTML = `<button class="location-btn success" title="Location captured!"><i class="fa-solid fa-check"></i></button>`; break;
                case 'error': locationButtonHTML = `<button class="location-btn error" title="Location error. Tap to retry." onclick="requestLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>`; break;
                default: locationButtonHTML = `<button class="location-btn" title="Turn on Location" onclick="requestLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>`;
            }
        }
        let pincodeStatusMsgHTML = '', locationStatusMsgHTML = '';
        if (items.length > 0) {
            if (!pincodeState.isValid) {
                pincodeStatusMsgHTML = `<div class="pincode-status-msg error">${pincodeState.message}</div>`;
            } else {
                let msg, className;
                switch(locationState.status) {
                    case 'loading': msg = 'Fetching your location...'; className = 'loading'; break;
                    case 'success': msg = 'Location captured! Ready to order.'; className = 'success'; break;
                    case 'error': msg = `Location Error: ${locationState.data}`; className = 'error'; break;
                    default: msg = 'Please turn on location to order.'; className = 'idle';
                }
                locationStatusMsgHTML = `<div class="location-status-msg ${className}">${msg}</div>`;
            }
        }
        const isWhatsAppDisabled = !pincodeState.isValid || locationState.status !== 'success';
        const cartHTML = `
            <div class="cart-wrapper">
                <div class="cart-header"><span>Your Order</span>${locationButtonHTML}</div>
                <div class="cart-items">${items.length === 0 ? `<div class="cart-empty-msg"><i class="fa-solid fa-cart-shopping"></i><p>Your cart is empty.</p><span>Add items to get started!</span></div>` : items.map(item => `
                    <div class="cart-item">
                        <img src="${(item.Images || [])[0]}" alt="${item.Name}">
                        <div class="details">
                            <p class="name">${item.Name}</p>
                            <p class="price">₹${item.Price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="quantity-control">
                            <button onclick="handleQuantityChange('${item.id}', -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="handleQuantityChange('${item.id}', 1)">+</button>
                        </div>
                    </div>`).join('')}
                </div>
                ${items.length > 0 ? `
                <div class="cart-footer">
                    <div class="cart-total"><span>Grand Total</span><span>₹${total.toFixed(2)}</span></div>
                    ${pincodeStatusMsgHTML}${locationStatusMsgHTML}
                    <div class="cart-actions">
                        <a href="#" id="whatsapp-order-btn" class="action-btn whatsapp-btn" ${isWhatsAppDisabled ? 'disabled' : ''}><i class="fab fa-whatsapp"></i> Order on WhatsApp</a>
                        <button class="action-btn secondary-btn" onclick="showCustomerInfoModal()"><i class="fa-solid fa-user-pen"></i> Edit My Info</button>
                    </div>
                </div>` : ''}
            </div>`;
        desktopCartContainer.innerHTML = cartHTML;
    }

    // --- Cart Logic Functions ---
    function getButtonHTML(product) {
        if (!product.InStock) return `<button class="add-to-cart-btn" disabled>Out of Stock</button>`;
        const itemInCart = cart.find(item => item.id === product.id);
        if (itemInCart) {
            return `<div class="quantity-control"><button onclick="handleQuantityChange('${product.id}', -1)">-</button><span>${itemInCart.quantity}</span><button onclick="handleQuantityChange('${product.id}', 1)">+</button></div>`;
        } else {
            return `<button class="add-to-cart-btn" onclick="handleAddToCart('${product.id}')">Add</button>`;
        }
    }

    function handleAddToCart(productId) {
        const product = ALL_PRODUCTS.find(p => p.id === productId);
        if (!product || !product.InStock) return;
        cart.push({ ...product, quantity: 1 });
        rerenderAll();
    }

    function handleQuantityChange(productId, change) {
        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
            cart[itemIndex].quantity += change;
            if (cart[itemIndex].quantity <= 0) {
                cart.splice(itemIndex, 1);
            }
        }
        rerenderAll();
    }
    
    function calculateCart() {
        const total = cart.reduce((sum, item) => sum + (item.Price * item.quantity), 0);
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        return { items: cart, total, count };
    }
    
    // --- Other Helper Functions ---
    function validatePincode(){ const customerPincode = localStorage.getItem('customerPincode'); if (customerPincode && VALID_PINCODES.includes(customerPincode)) { pincodeState = { isValid: true, message: 'Your area is serviceable!' }; } else if (customerPincode) { pincodeState = { isValid: false, message: `Sorry, we do not deliver to ${customerPincode}.` }; } else { pincodeState = { isValid: false, message: 'Add your pincode to check serviceability.' }; } }
    function requestLocation(){ if (!navigator.geolocation) { locationState = { status: 'error', data: 'Geolocation is not supported.' }; renderCart(); return; } locationState.status = 'loading'; renderCart(); navigator.geolocation.getCurrentPosition( (position) => { const { latitude, longitude } = position.coords; locationState = { status: 'success', data: { latitude, longitude, url: `https://maps.google.com/?q=${latitude},${longitude}` } }; renderCart(); }, (error) => { let message = 'An unknown error occurred.'; switch(error.code) { case error.PERMISSION_DENIED: message = "You denied the request for Geolocation."; break; case error.POSITION_UNAVAILABLE: message = "Location info is unavailable."; break; case error.TIMEOUT: message = "The request to get location timed out."; break; } locationState = { status: 'error', data: message }; renderCart(); }, { timeout: 10000 } ); }
    function handleCategoryChange(newCategory){ activeFilter = newCategory; rerenderAll(); }
    function showCustomerInfoModal(){ customerInfoModal.classList.add('visible'); }
    function hideCustomerInfoModal(){ customerInfoModal.classList.remove('visible'); }
    
    function setupWhatsappLink() {
        const whatsappBtn = document.getElementById('whatsapp-order-btn');
        if (!whatsappBtn) return;
        
        whatsappBtn.onclick = (e) => {
            e.preventDefault();
            if (whatsappBtn.hasAttribute('disabled')) return;
            
            const name = localStorage.getItem('customerName') || 'N/A';
            const phone = localStorage.getItem('customerPhone') || 'N/A';
            const address = localStorage.getItem('customerAddress') || 'N/A';
            const pincode = localStorage.getItem('customerPincode') || 'N/A';
            const landmark = localStorage.getItem('customerLandmark') || '';
            const locationURL = locationState.status === 'success' ? locationState.data.url : 'Location not provided.';
            
            const orderDetails = cart.map(item => `${item.quantity} x ${item.Name}`).join('\n');
            const { total } = calculateCart();
            
            const message = `*New Order*\n\n*Customer:*\nName: ${name}\nPhone: ${phone}\nAddress: ${address}, ${pincode}\nLandmark: ${landmark}\n\n*Order Details:*\n${orderDetails}\n\n*Total: ₹${total.toFixed(2)}*\n\n*Location:*\n${locationURL}\n\nThank you!`;
            
            window.open(`https://wa.me/917431059519?text=${encodeURIComponent(message)}`, '_blank');
        };
    }
    
    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchAllProducts();

        categoryNav.addEventListener('click', e => {
            e.preventDefault();
            const link = e.target.closest('a');
            if (link) {
                handleCategoryChange(link.dataset.category);
            }
        });
        
        document.getElementById('productSearch').addEventListener('input', () => rerenderAll());

        darkModeToggle.addEventListener('click', () => document.body.classList.toggle('dark'));
        
        const customerInfoForm = document.getElementById('customerInfoForm');
        customerInfoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(customerInfoForm);
            ['customerName', 'customerPhone', 'customerAddress', 'customerPincode', 'customerLandmark'].forEach(id => localStorage.setItem(id, formData.get(id).trim()));
            alert('Your info has been saved!');
            hideCustomerInfoModal();
            rerenderAll();
        });
        document.getElementById('cancelCustomerInfoBtn').addEventListener('click', hideCustomerInfoModal);
        
        // This is important for the WhatsApp button to work after the cart is rendered
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.addedNodes.length) {
                    if (document.getElementById('whatsapp-order-btn')) {
                        setupWhatsappLink();
                        break; 
                    }
                }
            }
        });
        observer.observe(desktopCartContainer, { childList: true, subtree: true });
    });
</script>
</body>
</html>
i provide you the full code, so now what to do
